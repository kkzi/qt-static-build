name: Build Qt6 Windows
on:
    workflow_dispatch:
        inputs:
            version:
                description: 'Build version'
                required: true
                type: string
                default: 'dev'
            arch:
                description: 'Build arch'
                type: choice
                options:
                  - x64
                  - x86
                required: true
            src_dir:
                description: 'Download Qt Source Directory'
                required: true
                type: string
                default: 'D:/Qt6/qtbase'
            install_dir:
                description: 'Install Qt Libs Directory'
                required: true
                type: string
                default: 'C:/Local/Qt6'
            configure-args:
                description: 'Build args'
                required: false
                type: string

jobs:
    build:
        name: Build
        runs-on: windows-2019

        steps:
            - name: Set up Visual Studio shell on Windows
              uses: egor-tensin/vs-shell@v2
              with:
                  arch: ${{ inputs.arch }}
            
            - name: Setup Environment
              working-directory: "C:/"
              shell: pwsh
              run: |
                mkdir -p ${{ inputs.src_dir }}
                mkdir -p ${{ inputs.install_dir }}

            - name: Download Qt
              working-directory: "${{ inputs.src_dir }}"
              shell: pwsh
              run: | 
                git clone https://github.com/qt/qtbase.git -b ${{ inputs.version }} ${{ inputs.src_dir }}
                cd ${{ inputs.src_dir }}

            - name: Build
              working-directory: "${{ inputs.src_dir }}"
              shell: pwsh
              run: |
                configure.bat -prefix "${{ inputs.install_dir }}" -static -static-runtime -debug-and-release -confirm-license -opensource -optimize-size -c++std c++20
                cmake --build . -j
                cmake --install .

            - name: Package output files
              working-directory: "D:/"
              shell: pwsh
              run: |
                7z a -t7z qt-${{inputs.version}}-${{inputs.arch}}-static.7z "${{ inputs.install_dir }}/*"

            - uses: actions/upload-artifact@v3
              with:
                  path: "D:/qt-${{inputs.version}}-${{inputs.arch}}-static.7z"
